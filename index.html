<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #181818;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Form Styles */
        .login-container {
            background: rgba(24, 24, 24, 0.98);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            margin: 0 auto;
            text-align: center;
        }

        .logo-container {
            margin-bottom: 30px;
        }

        .logo-placeholder {
            width: 120px;
            height: 120px;
            background: none;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            /* Remove font styles, show only image */
        }

        .login-title {
            color: #fff;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
        }

        .form-group label {
            color: #eee;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .form-group input {
            background: #222;
            color: #fff;
            border: 2px solid #333;
        }

        .form-group input:focus {
            border-color: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.07);
        }

        .mfa-step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .mfa-step h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .qr-code-placeholder {
            width: 200px;
            height: 200px;
            background: #fff;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            color: #666;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(90deg, #fff 0%, #666 100%);
            color: #181818;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }

        .btn:hover {
            background: linear-gradient(90deg, #666 0%, #fff 100%);
            color: #181818;
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.07);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            background: rgba(24, 24, 24, 0.98);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .dashboard-title {
            font-family: 'Montserrat', sans-serif;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #222;
            border-radius: 15px;
            padding: 5px;
            gap: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: #bbb;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #fff;
            color: #181818;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.07);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .service-section {
            background: #222;
            color: #fff;
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }

        .service-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #181818;
            font-size: 20px;
        }

        .proxmox-icon,
        .pfsense-icon,
        .minio-icon {
            background: #fff;
            color: #181818;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .action-card {
            background: #181818;
            color: #fff;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .action-card:hover {
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.07);
        }

        .action-card h4 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .action-card p {
            color: #ddd;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .action-btn {
            background: linear-gradient(90deg, #fff 0%, #666 100%);
            color: #181818;
        }

        .action-btn:hover {
            background: linear-gradient(90deg, #666 0%, #fff 100%);
            color: #181818;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            color: #fff;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }

        .close {
            font-size: 30px;
            cursor: pointer;
            color: #fff;
            line-height: 1;
        }

        .close:hover {
            color: #bbb;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #fff;
        }

        .status-offline {
            background: #dc3545;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #fff;
            color: #181818;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1001;
        }

        .notification.error {
            background: #dc3545;
            color: #fff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .secret-key {
            background: #222;
            border: 2px dashed #fff;
            color: #fff;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Login Form -->
        <div class="login-container" id="loginContainer">
            <div class="logo-container">
                <img src="Atominate_logo-02.png" alt="Atominate Logo" class="logo-placeholder">
                <div
                    style="font-family: 'Montserrat', sans-serif; font-size: 22px; letter-spacing: 8px; color: #fff; margin-bottom: 10px;">
                    ATOMINATE</div>
                <h2 class="login-title"></h2>
            </div>

            <!-- Initial Login -->
            <div id="initialLogin">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button class="btn" onclick="initiateLogin()">Login</button>
            </div>

            <!-- MFA Setup -->
            <div id="mfaSetup" style="display: none;">
                <h3 style="color: #333; margin-bottom: 20px;">Setup Google Authenticator</h3>

                <div class="mfa-step">
                    <h4>Step 1: Install Google Authenticator</h4>
                    <p>Download Google Authenticator from your app store if you haven't already.</p>
                </div>

                <div class="mfa-step">
                    <h4>Step 2: Scan QR Code</h4>
                    <div class="qr-code-placeholder" id="qrCode">
                        QR Code will appear here<br>
                        <small>(In production, generate actual QR code)</small>
                    </div>
                    <p><strong>Or enter this secret key manually:</strong></p>
                    <div class="secret-key" id="secretKey">ABCD EFGH IJKL MNOP</div>
                </div>

                <div class="mfa-step">
                    <h4>Step 3: Enter Verification Code</h4>
                    <div class="form-group">
                        <input type="text" id="mfaCode" placeholder="Enter 6-digit code from app" maxlength="6">
                    </div>
                </div>

                <button class="btn" onclick="verifyMFA()">Verify & Complete Setup</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </div>

            <!-- MFA Verification (for returning users) -->
            <div id="mfaVerification" style="display: none;">
                <h3 style="color: #333; margin-bottom: 20px;">Two-Factor Authentication</h3>
                <p style="margin-bottom: 20px; color: #666;">Please enter the 6-digit code from your Google
                    Authenticator app.</p>

                <div class="form-group">
                    <label for="verifyCode">Verification Code</label>
                    <input type="text" id="verifyCode" placeholder="000000" maxlength="6">
                </div>

                <button class="btn" onclick="verifyLoginMFA()">Verify</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <img src="Atominate_logo-02.png" alt="Atominate Logo" class="logo-placeholder"
                        style="width: 50px; height: 50px; margin-right: 10px;">
                    <span style="font-family: 'Montserrat', sans-serif; letter-spacing: 6px;">ATOMINATE</span>
                    Infrastructure Dashboard
                </h1>
                <div class="user-info">
                    <span>Welcome, <strong id="currentUser">Admin</strong></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('proxmox')">Proxmox VE</button>
                <button class="nav-tab" onclick="showTab('pfsense')">pfSense</button>
                <button class="nav-tab" onclick="showTab('minio')">MinIO</button>
                <button class="nav-tab" onclick="showTab('settings')">Settings</button>
                <!-- Settings Tab -->
                <div class="tab-content" id="settings">
                    <div class="service-section">
                        <div class="service-header">
                            <div class="service-icon">⚙️</div>
                            <div>
                                <h3>General Settings</h3>
                            </div>
                        </div>
                        <div class="action-grid">
                            <div class="action-card">
                                <h4>Create User</h4>
                                <button class="action-btn" onclick="openModal('createUser')">Create User</button>
                            </div>
                            <div class="action-card">
                                <h4>Set OTP</h4>
                                <button class="action-btn" onclick="openModal('setOTP')">Set OTP</button>
                            </div>
                            <div class="action-card">
                                <h4>Set NTP Server</h4>
                                <button class="action-btn" onclick="openModal('setNTP')">Set NTP</button>
                            </div>
                            <div class="action-card">
                                <h4>Set Language</h4>
                                <button class="action-btn" onclick="openModal('setLanguage')">Set Language</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proxmox Tab -->
            <div class="tab-content active" id="proxmox">
                <div class="service-section" style="display: flex; gap: 30px;">
                    <!-- VM List -->
                    <div style="flex:2;">
                        <div class="service-header">
                            <div class="service-icon proxmox-icon">PVE</div>
                            <div>
                                <h3>Proxmox Virtual Environment</h3>
                                <p>Status: <span class="status-indicator status-online"></span>Online</p>
                            </div>
                        </div>
                        <h4 style="margin: 20px 0 10px 0; font-family: 'Montserrat',sans-serif; letter-spacing:2px;">
                            Running
                            VMs</h4>
                        <div id="vmList" style="margin-bottom: 20px;">
                            <!-- VM items will be rendered here -->
                        </div>
                        <div id="vmDetails" style="margin-bottom: 20px;">
                            <!-- Selected VM details will be rendered here -->
                        </div>
                    </div>
                    <!-- Side Menu for VM Actions -->
                    <div style="flex:1; min-width:220px; background:#222; border-radius:12px; padding:20px;">
                        <h4 style="font-family:'Montserrat',sans-serif; letter-spacing:2px; margin-bottom:15px;">
                            VM Actions</h4>
                        <button class="action-btn" style="margin-bottom:10px;" onclick="openVMAction('createVM')">Create
                            VM</button>
                        <button class="action-btn" style="margin-bottom:10px;" onclick="openVMAction('importVM')">Import
                            VM</button>
                        <button class="action-btn" style="margin-bottom:10px;" onclick="openClusterModal()">Setup
                            Cluster Node</button>
                    </div>
                </div>
            </div>

            <!-- pfSense Tab -->
            <div class="tab-content" id="pfsense">
                <div class="service-section">
                    <div class="service-header">
                        <div class="service-icon pfsense-icon">pf</div>
                        <div>
                            <h3>pfSense Firewall</h3>
                            <p>Status: <span class="status-indicator status-online"></span>Online</p>
                        </div>
                    </div>

                    <div class="action-grid">
                        <div class="action-card">
                            <h4>Create VPN</h4>
                            <p>Setup OpenVPN or IPSec VPN connections</p>
                            <button class="action-btn" onclick="openModal('createVPN')">Create VPN</button>
                        </div>

                        <div class="action-card">
                            <h4>Firewall Rules</h4>
                            <p>Create and manage firewall rules and policies</p>
                            <button class="action-btn" onclick="openModal('firewallRules')">Manage Rules</button>
                        </div>

                        <div class="action-card">
                            <h4>Port Forwarding</h4>
                            <p>Configure NAT and port forwarding rules</p>
                            <button class="action-btn" onclick="openModal('portForwarding')">Port Forwarding</button>
                        </div>

                        <div class="action-card">
                            <h4>Traffic Monitoring</h4>
                            <p>Monitor network traffic and bandwidth usage</p>
                            <button class="action-btn" onclick="openModal('trafficMonitor')">View Traffic</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MinIO Tab -->
            <div class="tab-content" id="minio">
                <div class="service-section">
                    <div class="service-header">
                        <div class="service-icon minio-icon">S3</div>
                        <div>
                            <h3>MinIO Object Storage</h3>
                            <p>Status: <span class="status-indicator status-online"></span>Online</p>
                        </div>
                    </div>

                    <div class="action-grid">
                        <div class="action-card">
                            <h4>Create Bucket</h4>
                            <p>Create new S3-compatible storage bucket</p>
                            <button class="action-btn" onclick="openModal('createBucket')">Create Bucket</button>
                        </div>

                        <div class="action-card">
                            <h4>WORM Configuration</h4>
                            <p>Configure Write-Once Read-Many policies</p>
                            <button class="action-btn" onclick="openModal('wormConfig')">Setup WORM</button>
                        </div>

                        <div class="action-card">
                            <h4>Access Policies</h4>
                            <p>Manage bucket access policies and permissions</p>
                            <button class="action-btn" onclick="openModal('accessPolicies')">Manage Access</button>
                        </div>

                        <div class="action-card">
                            <h4>Storage Analytics</h4>
                            <p>View storage usage and performance metrics</p>
                            <button class="action-btn" onclick="openModal('storageAnalytics')">View Analytics</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for various actions -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Action</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global state
        let currentUser = null;
        let mfaSetupComplete = false;
        let isLoggedIn = false;
        let jwtToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user has MFA setup (simulate checking local storage in production)
            mfaSetupComplete = localStorage.getItem('mfaSetup') === 'true';
        });

        // Login functions
        function initiateLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showNotification('Please enter both username and password', 'error');
                return;
            }

            // Real API call
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            })
                .then(res => res.json())
                .then(data => {
                    if (data.access_token) {
                        jwtToken = data.access_token;
                        currentUser = username;
                        // Check if MFA is setup (call backend or localStorage)
                        fetch(`/api/mfa/setup?username=${encodeURIComponent(username)}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${jwtToken}` }
                        })
                            .then(res => res.json())
                            .then(mfa => {
                                if (mfa.secret) {
                                    showMFASetup(mfa.secret);
                                } else {
                                    showMFAVerification();
                                }
                            });
                    } else {
                        showNotification('Invalid credentials', 'error');
                    }
                })
                .catch(() => showNotification('Login failed', 'error'));
        }

        function showMFASetup(secret) {
            document.getElementById('initialLogin').style.display = 'none';
            document.getElementById('mfaSetup').style.display = 'block';
            document.getElementById('secretKey').textContent = formatSecretKey(secret);
            // Generate QR code using Google Charts API
            const otpauth = `otpauth://totp/ATOMINATE:${currentUser}?secret=${secret}&issuer=ATOMINATE`;
            document.getElementById('qrCode').innerHTML = `<img src='https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(otpauth)}' alt='QR Code'>`;
        }

        function showMFAVerification() {
            document.getElementById('initialLogin').style.display = 'none';
            document.getElementById('mfaVerification').style.display = 'block';
        }

        function verifyMFA() {
            const code = document.getElementById('mfaCode').value;

            if (!code || code.length !== 6) {
                showNotification('Please enter a valid 6-digit code', 'error');
                return;
            }

            // Real API call
            fetch('/api/mfa/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ username: currentUser, code })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'MFA verified') {
                        mfaSetupComplete = true;
                        showDashboard();
                        showNotification('MFA setup completed successfully!');
                    } else {
                        showNotification('Invalid MFA code', 'error');
                    }
                })
                .catch(() => showNotification('MFA verification failed', 'error'));
        }

        function verifyLoginMFA() {
            const code = document.getElementById('verifyCode').value;

            if (!code || code.length !== 6) {
                showNotification('Please enter a valid 6-digit code', 'error');
                return;
            }

            // Real API call
            fetch('/api/mfa/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ username: currentUser, code })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'MFA verified') {
                        showDashboard();
                        showNotification('Login successful!');
                    } else {
                        showNotification('Invalid MFA code', 'error');
                    }
                })
                .catch(() => showNotification('MFA verification failed', 'error'));
        }

        function showLogin() {
            document.getElementById('initialLogin').style.display = 'block';
            document.getElementById('mfaSetup').style.display = 'none';
            document.getElementById('mfaVerification').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
            isLoggedIn = true;
        }

        function logout() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('verifyCode').value = '';
            showLogin();
            isLoggedIn = false;
            currentUser = null;
        }

        // Dashboard functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Modal functions
        function openModal(action, vmId) {
            const modal = document.getElementById('actionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            modalTitle.textContent = getModalTitle(action) + (vmId ? ` (VM ${vmId})` : '');
            modalBody.innerHTML = getModalContent(action, vmId);
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        function getModalTitle(action) {
            const titles = {
                'createVM': 'Create Virtual Machine',
                'importVM': 'Import Virtual Machine',
                'setupReplication': 'Setup Replication',
                'snapshotManagement': 'Restore from Snapshot',
                'restoreSnapshot': 'Restore from Snapshot',
                'createVPN': 'Create VPN Connection',
                'firewallRules': 'Firewall Rules',
                'portForwarding': 'Port Forwarding',
                'trafficMonitor': 'Traffic Monitor',
                'createBucket': 'Create Storage Bucket',
                'wormConfig': 'WORM Configuration',
                'accessPolicies': 'Access Policies',
                'storageAnalytics': 'Storage Analytics',
                'setupClusterNode': 'Setup Cluster Node',
                'backupVM': 'Backup VM',
                'createUser': 'Create User',
                'setOTP': 'Set OTP',
                'setNTP': 'Set NTP Server',
                'setLanguage': 'Set Language'
            };
            return titles[action] || 'Action';
        }

        function getModalContent(action, vmId) {
            let vmInfo = '';
            if (vmId) {
                const vm = vmData.find(v => v.id === vmId);
                if (vm) {
                    vmInfo = `
                        <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:15px; color:#fff;">
                            <strong>${vm.name}</strong> (ID: ${vm.id})<br>
                            OS: ${vm.os} • CPU: ${vm.cpu} • RAM: ${vm.mem}GB<br>
                            CPU Usage: ${vm.cpuUsage || '20%'} | RAM Usage: ${vm.ramUsage || '2GB/4GB'} | Disk Usage: ${vm.diskUsage || '10GB/50GB'}
                        </div>
                    `;
                }
            }
            const content = {
                'backupVM': `
                    <div class="form-group">
                        <label>Backup Frequency</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Daily</option>
                            <option>Weekly</option>
                            <option>Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Backup Day</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                            <option>Sunday</option>
                        </select>
                    </div>
                    <button class="btn" onclick="executeAction('backupVM')">Set Backup</button>
                `,
                'createUser': `
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="executeAction('createUser')">Create User</button>
                `,
                'setOTP': `
                    <div class="form-group">
                        <label>Set OTP Secret</label>
                        <input type="text" placeholder="Enter OTP secret">
                    </div>
                    <button class="btn" onclick="executeAction('setOTP')">Set OTP</button>
                `,
                'setNTP': `
                    <div class="form-group">
                        <label>NTP Server</label>
                        <input type="text" placeholder="pool.ntp.org">
                    </div>
                    <button class="btn" onclick="executeAction('setNTP')">Set NTP</button>
                `,
                'setLanguage': `
                    <div class="form-group">
                        <label>Language</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option value="en">English</option>
                            <option value="it">Italiano</option>
                        </select>
                    </div>
                    <button class="btn" onclick="executeAction('setLanguage')">Set Language</button>
                `,
                'createVM': `
                    <div class="form-row">
                        <div class="form-group">
                            <label>VM Name</label>
                            <input type="text" placeholder="Enter VM name">
                        </div>
                        <div class="form-group">
                            <label>VM ID</label>
                            <input type="number" placeholder="100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>CPU Cores</label>
                            <input type="number" placeholder="2" min="1">
                        </div>
                        <div class="form-group">
                            <label>Memory (GB)</label>
                            <input type="number" placeholder="4" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Disk Size (GB)</label>
                        <input type="number" placeholder="50" min="10">
                    </div>
                    <div class="form-group">
                        <label>Operating System</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Ubuntu 22.04 LTS</option>
                            <option>Windows Server 2022</option>
                            <option>CentOS 8</option>
                            <option>Debian 11</option>
                        </select>
                    </div>
                    <button class="btn" onclick="executeAction('createVM')">Create Virtual Machine</button>
                `,

                'importVM': `
                    <div class="form-group">
                        <label>Import Source</label>
                        <select id="importSource" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>OVF/OVA File</option>
                            <option>VMware ESXi</option>
                            <option>Hyper-V</option>
                            <option>Disk Image</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>File Path or URL</label>
                        <input type="text" placeholder="/path/to/vm.ova or https://...">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Target VM ID</label>
                            <input type="number" placeholder="101">
                        </div>
                        <div class="form-group">
                            <label>Target Storage</label>
                            <input type="text" placeholder="local-lvm">
                        </div>
                    </div>
                    <button class="btn" onclick="executeAction('importVM')">Import Virtual Machine</button>
                `,

                'setupReplication': `
                    <div class="form-group">
                        <label>Source VM</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>VM 100 - Web Server</option>
                            <option>VM 101 - Database Server</option>
                            <option>VM 102 - Application Server</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Node/Cluster</label>
                        <input type="text" placeholder="backup-node.local">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Schedule</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>Every 15 minutes</option>
                                <option>Hourly</option>
                                <option>Daily</option>
                                <option>Weekly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Retention (days)</label>
                            <input type="number" placeholder="7" min="1">
                        </div>
                    </div>
                    <button class="btn" onclick="executeAction('setupReplication')">Setup Replication</button>
                `,

                'snapshotManagement': `
                    <div class="form-group">
                        <label>Select VM</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>VM 100 - Web Server</option>
                            <option>VM 101 - Database Server</option>
                            <option>VM 102 - Application Server</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Snapshot Name</label>
                        <input type="text" placeholder="before-update-$(date)">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" placeholder="Pre-update snapshot">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="executeAction('createSnapshot')">Create Snapshot</button>
                        <button class="btn btn-secondary" onclick="listSnapshots()">List Snapshots</button>
                    </div>
                `,

                'restoreSnapshot': `
                    <div class="form-group">
                        <label>Select VM</label>
                        <select id="vmSelect" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>VM 100 - Web Server</option>
                            <option>VM 101 - Database Server</option>
                            <option>VM 102 - Application Server</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Available Snapshots</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>before-update-2024-01-15</option>
                            <option>pre-maintenance-2024-01-14</option>
                            <option>weekly-backup-2024-01-10</option>
                        </select>
                    </div>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <strong>⚠️ Warning:</strong> This will restore the VM to the selected snapshot state. All changes made after the snapshot will be lost.
                    </div>
                    <button class="btn" onclick="executeAction('restoreSnapshot')">Restore from Snapshot</button>
                `,

                'createVPN': `
                    <div class="form-group">
                        <label>VPN Type</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>OpenVPN</option>
                            <option>IPSec</option>
                            <option>WireGuard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Connection Name</label>
                        <input type="text" placeholder="Branch Office VPN">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Remote Gateway</label>
                            <input type="text" placeholder="203.0.113.10">
                        </div>
                        <div class="form-group">
                            <label>Local Network</label>
                            <input type="text" placeholder="192.168.1.0/24">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Remote Network</label>
                            <input type="text" placeholder="10.0.0.0/24">
                        </div>
                        <div class="form-group">
                            <label>Encryption</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>AES-256</option>
                                <option>AES-128</option>
                                <option>3DES</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="executeAction('createVPN')">Create VPN Connection</button>
                `,

                'firewallRules': `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Action</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>Allow</option>
                                <option>Block</option>
                                <option>Reject</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Interface</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>WAN</option>
                                <option>LAN</option>
                                <option>DMZ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Protocol</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>TCP</option>
                                <option>UDP</option>
                                <option>ICMP</option>
                                <option>Any</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Port/Port Range</label>
                            <input type="text" placeholder="80, 443, 8000-8080">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Source</label>
                            <input type="text" placeholder="any, 192.168.1.0/24, or specific IP">
                        </div>
                        <div class="form-group">
                            <label>Destination</label>
                            <input type="text" placeholder="any, 10.0.0.0/24, or specific IP">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" placeholder="Allow HTTP/HTTPS traffic">
                    </div>
                    <button class="btn" onclick="executeAction('firewallRules')">Create Firewall Rule</button>
                `,

                'portForwarding': `
                    <div class="form-row">
                        <div class="form-group">
                            <label>External Port</label>
                            <input type="number" placeholder="80">
                        </div>
                        <div class="form-group">
                            <label>Internal IP</label>
                            <input type="text" placeholder="192.168.1.100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Internal Port</label>
                            <input type="number" placeholder="8080">
                        </div>
                        <div class="form-group">
                            <label>Protocol</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>TCP</option>
                                <option>UDP</option>
                                <option>Both</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" placeholder="Web server port forwarding">
                    </div>
                    <button class="btn" onclick="executeAction('portForwarding')">Create Port Forward</button>
                `,

                'trafficMonitor': `
                    <div style="text-align: center; padding: 20px;">
                        <h4>Network Traffic Overview</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <h5>WAN Traffic</h5>
                                <p style="font-size: 24px; font-weight: bold; color: #667eea;">1.2 GB</p>
                                <small>Last 24 hours</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <h5>LAN Traffic</h5>
                                <p style="font-size: 24px; font-weight: bold; color: #28a745;">856 MB</p>
                                <small>Last 24 hours</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <h5>Active Connections</h5>
                                <p style="font-size: 24px; font-weight: bold; color: #ffc107;">47</p>
                                <small>Current</small>
                            </div>
                        </div>
                        <button class="btn" onclick="executeAction('refreshTraffic')">Refresh Data</button>
                    </div>
                `,

                'createBucket': `
                    <div class="form-group">
                        <label>Bucket Name</label>
                        <input type="text" placeholder="my-storage-bucket" pattern="[a-z0-9-]+">
                        <small style="color: #666;">Only lowercase letters, numbers, and hyphens allowed</small>
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>us-east-1</option>
                            <option>us-west-2</option>
                            <option>eu-west-1</option>
                            <option>local</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Versioning</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Disabled</option>
                            <option>Enabled</option>
                            <option>Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Access Level</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Private</option>
                            <option>Public Read</option>
                            <option>Public Read/Write</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Retention Period (days)</label>
                        <input type="number" placeholder="30" min="1">
                    </div>
                    <button class="btn" onclick="executeAction('createBucket')">Create Bucket</button>
                `,

                'wormConfig': `
                    <div class="form-group">
                        <label>Select Bucket</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>compliance-data</option>
                            <option>backup-storage</option>
                            <option>archive-bucket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Retention Mode</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>Governance</option>
                            <option>Compliance</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Retention Period</label>
                            <input type="number" placeholder="30" min="1">
                        </div>
                        <div class="form-group">
                            <label>Period Unit</label>
                            <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                                <option>Days</option>
                                <option>Months</option>
                                <option>Years</option>
                            </select>
                        </div>
                    </div>
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <strong>ℹ️ WORM Policy:</strong> Once enabled, objects cannot be deleted or modified for the specified retention period.
                    </div>
                    <button class="btn" onclick="executeAction('wormConfig')">Configure WORM Policy</button>
                `,

                'accessPolicies': `
                    <div class="form-group">
                        <label>Policy Name</label>
                        <input type="text" placeholder="ReadOnlyAccess">
                    </div>
                    <div class="form-group">
                        <label>Select Bucket</label>
                        <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                            <option>All Buckets</option>
                            <option>compliance-data</option>
                            <option>backup-storage</option>
                            <option>archive-bucket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>User/Group</label>
                        <input type="text" placeholder="username or group-name">
                    </div>
                    <div class="form-group">
                        <label>Permissions</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <label><input type="checkbox" checked> Read Objects</label>
                            <label><input type="checkbox"> Write Objects</label>
                            <label><input type="checkbox"> Delete Objects</label>
                            <label><input type="checkbox"> List Bucket</label>
                            <label><input type="checkbox"> Read ACL</label>
                            <label><input type="checkbox"> Write ACL</label>
                        </div>
                    </div>
                    <button class="btn" onclick="executeAction('accessPolicies')">Create Access Policy</button>
                `,

                'storageAnalytics': `
                    <div style="text-align: center; padding: 20px;">
                        <h4>Storage Usage Analytics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h5>Total Storage</h5>
                                <p style="font-size: 32px; font-weight: bold; color: #667eea;">2.4 TB</p>
                                <small>Used of 10 TB capacity</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h5>Total Objects</h5>
                                <p style="font-size: 32px; font-weight: bold; color: #28a745;">1.2M</p>
                                <small>Across all buckets</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h5>Active Buckets</h5>
                                <p style="font-size: 32px; font-weight: bold; color: #ffc107;">15</p>
                                <small>Currently in use</small>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h5>Top Buckets by Size</h5>
                            <div style="text-align: left; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                    <span>backup-storage</span>
                                    <span>1.1 TB</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                    <span>media-archive</span>
                                    <span>856 GB</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                    <span>compliance-data</span>
                                    <span>445 GB</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn" onclick="executeAction('refreshAnalytics')">Refresh Analytics</button>
                    </div>
                `
            };
            return (vmInfo ? vmInfo : '') + (content[action] || '<p>Action content not found.</p>');
        }

        // Execute actions
        function executeAction(action) {
            showNotification('Executing action: ' + action);

            // Simulate API calls with loading states
            const button = event.target;
            const originalText = button.textContent;
            button.innerHTML = originalText + '<span class="loading"></span>';
            button.disabled = true;

            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                closeModal();
                showNotification(getActionSuccessMessage(action));
            }, 2000);
        }

        function getActionSuccessMessage(action) {
            const messages = {
                'createVM': 'Virtual machine created successfully!',
                'importVM': 'Virtual machine imported successfully!',
                'setupReplication': 'Replication configured successfully!',
                'createSnapshot': 'Snapshot created successfully!',
                'restoreSnapshot': 'VM restored from snapshot successfully!',
                'createVPN': 'VPN connection created successfully!',
                'firewallRules': 'Firewall rule created successfully!',
                'portForwarding': 'Port forwarding rule created successfully!',
                'refreshTraffic': 'Traffic data refreshed!',
                'createBucket': 'Storage bucket created successfully!',
                'wormConfig': 'WORM policy configured successfully!',
                'accessPolicies': 'Access policy created successfully!',
                'refreshAnalytics': 'Storage analytics refreshed!',
                'setupClusterNode': 'Cluster node setup successfully!'
            };
            return messages[action] || 'Action completed successfully!';
        }

        // VM data (example)
        const vmData = [
            { id: 100, name: "Web Server", status: "running", os: "Ubuntu 22.04", cpu: 2, mem: 4 },
            { id: 101, name: "Database Server", status: "running", os: "CentOS 8", cpu: 4, mem: 8 },
            { id: 102, name: "App Server", status: "running", os: "Windows Server", cpu: 2, mem: 6 }
        ];
        let selectedVMId = null;

        // Render VM list with per-VM actions
        // Render simplified VM list with main actions and usage
        function renderVMList() {
            const vmList = document.getElementById('vmList');
            vmList.innerHTML = vmData.map(vm => `
                <div style="background:#181818; border:1px solid #333; border-radius:8px; padding:15px; margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>${vm.name}</strong> (ID: ${vm.id})<br>
                            Status: <span style="color:${vm.status === 'running' ? '#28a745' : '#dc3545'}">${vm.status}</span>
                        </div>
                        <div>
                            <button class="action-btn" onclick="runVM(${vm.id})">Run</button>
                            <button class="action-btn" onclick="stopVM(${vm.id})">Stop</button>
                            <button class="action-btn" onclick="hibernateVM(${vm.id})">Hibernate</button>
                            <button class="action-btn" onclick="restartVM(${vm.id})">Restart</button>
                            <button class="action-btn" onclick="openModal('backupVM', ${vm.id})">Backup</button>
                            <button class="action-btn" onclick="openModal('setupReplication', ${vm.id})">Replication</button>
                            <button class="action-btn" onclick="openModal('snapshotManagement', ${vm.id})">Snapshots</button>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <span>CPU: ${vm.cpuUsage || '20%'} | RAM: ${vm.ramUsage || '2GB/4GB'} | Disk: ${vm.diskUsage || '10GB/50GB'}</span>
                    </div>
                </div>
            `).join('');
            renderVMDetails();
        }

        // Show selected VM details
        function renderVMDetails() {
            const details = document.getElementById('vmDetails');
            if (!selectedVMId) {
                details.innerHTML = '<div style="color:#bbb; font-size:15px;">Select a VM to view details.</div>';
                return;
            }
            const vm = vmData.find(v => v.id === selectedVMId);
            if (!vm) {
                details.innerHTML = '';
                return;
            }
            details.innerHTML = `
                <div style="background:#222; border-radius:8px; padding:18px; margin-top:10px;">
                    <h4 style="font-family:'Montserrat',sans-serif; letter-spacing:2px; margin-bottom:10px;">VM Details</h4>
                    <div><strong>Name:</strong> ${vm.name}</div>
                    <div><strong>ID:</strong> ${vm.id}</div>
                    <div><strong>Status:</strong> ${vm.status}</div>
                    <div><strong>OS:</strong> ${vm.os}</div>
                    <div><strong>CPU:</strong> ${vm.cpu}</div>
                    <div><strong>RAM:</strong> ${vm.mem} GB</div>
                    <div><strong>IP Address:</strong> ${vm.ip || '192.168.1.' + vm.id}</div>
                    <div><strong>Uptime:</strong> ${vm.uptime || '2 days 4 hours'}</div>
                    <div><strong>CPU Usage:</strong> ${vm.cpuUsage || '20%'}</div>
                    <div><strong>RAM Usage:</strong> ${vm.ramUsage || '2GB/4GB'}</div>
                    <div><strong>Disk Usage:</strong> ${vm.diskUsage || '10GB/50GB'}</div>
                    <div style="margin-top:18px; display:flex; gap:10px;">
                        <button class="action-btn" style="flex:1;" onclick="runVM(${vm.id})">Run</button>
                        <button class="action-btn" style="flex:1;" onclick="stopVM(${vm.id})">Stop</button>
                        <button class="action-btn" style="flex:1;" onclick="hibernateVM(${vm.id})">Hibernate</button>
                        <button class="action-btn" style="flex:1;" onclick="restartVM(${vm.id})">Restart</button>
                        <button class="action-btn" style="flex:1;" onclick="openModal('backupVM', ${vm.id})">Backup</button>
                    </div>
                </div>
            `;
        }

        // Example VM actions
        function runVM(id) {
            // Real API call
            fetch(`/api/vm/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ action: 'start' })
            })
                .then(res => res.json())
                .then(data => {
                    showNotification('Running VM ' + id);
                    // Optionally refresh VM list from backend
                });
        }
        function stopVM(id) {
            fetch(`/api/vm/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ action: 'stop' })
            })
                .then(res => res.json())
                .then(data => {
                    showNotification('Stopping VM ' + id);
                });
        }
        function hibernateVM(id) {
            fetch(`/api/vm/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ action: 'suspend' })
            })
                .then(res => res.json())
                .then(data => {
                    showNotification('Hibernating VM ' + id);
                });
        }
        function restartVM(id) {
            fetch(`/api/vm/${id}/action`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ action: 'reset' })
            })
                .then(res => res.json())
                .then(data => {
                    showNotification('Restarting VM ' + id);
                });
        }

        // Open modal for selected VM
        function openVMAction(action) {
            if (!selectedVMId && action !== 'createVM' && action !== 'importVM') {
                showNotification('Please select a VM first', 'error');
                return;
            }
            openModal(action, selectedVMId);
        }

        // Add cluster node modal logic
        function openClusterModal() {
            const modal = document.getElementById('actionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            modalTitle.textContent = 'Setup Cluster Node';
            modalBody.innerHTML = `
            <div class="form-group">
                <label>Node Hostname/IP</label>
                <input type="text" id="clusterNodeHost" placeholder="node.example.com or 192.168.1.10">
            </div>
            <div class="form-group">
                <label>Node Name</label>
                <input type="text" id="clusterNodeName" placeholder="Node Name">
            </div>
            <div class="form-group">
                <label>Join Token</label>
                <input type="text" id="clusterNodeToken" placeholder="Cluster Join Token">
            </div>
            <button class="btn" onclick="setupClusterNode()">Add Node to Cluster</button>
        `;
            modal.style.display = 'block';
        }

        function setupClusterNode() {
            const host = document.getElementById('clusterNodeHost').value;
            const name = document.getElementById('clusterNodeName').value;
            const token = document.getElementById('clusterNodeToken').value;
            if (!host || !name || !token) {
                showNotification('Please fill all cluster node fields', 'error');
                return;
            }
            const button = event.target;
            const originalText = button.textContent;
            button.innerHTML = originalText + '<span class="loading"></span>';
            button.disabled = true;
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                closeModal();
                showNotification(`Node "${name}" added to cluster!`);
            }, 2000);
        }

        // On DOMContentLoaded, render VM list
        document.addEventListener('DOMContentLoaded', function () {
            renderVMList();
        });

        // Utility functions
        function generateMFASecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 16; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        function formatSecretKey(secret) {
            return secret.match(/.{1,4}/g).join(' ');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function listSnapshots() {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h4>Available Snapshots</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; margin: 10px 0; border-radius: 8px;">
                        <div>
                            <strong>before-update-2024-01-15</strong><br>
                            <small>Size: 12.3 GB • Created: 2024-01-15 14:30:00</small>
                        </div>
                        <div>
                            <button class="btn" style="padding: 5px 10px; font-size: 14px;" onclick="restoreFromSnapshot('before-update-2024-01-15')">Restore</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; margin: 10px 0; border-radius: 8px;">
                        <div>
                            <strong>pre-maintenance-2024-01-14</strong><br>
                            <small>Size: 11.8 GB • Created: 2024-01-14 09:15:00</small>
                        </div>
                        <div>
                            <button class="btn" style="padding: 5px 10px; font-size: 14px;" onclick="restoreFromSnapshot('pre-maintenance-2024-01-14')">Restore</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; margin: 10px 0; border-radius: 8px;">
                        <div>
                            <strong>weekly-backup-2024-01-10</strong><br>
                            <small>Size: 10.2 GB • Created: 2024-01-10 02:00:00</small>
                        </div>
                        <div>
                            <button class="btn" style="padding: 5px 10px; font-size: 14px;" onclick="restoreFromSnapshot('weekly-backup-2024-01-10')">Restore</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="openModal('snapshotManagement')">Back to Snapshot Management</button>
            `;
        }

        function restoreFromSnapshot(snapshotName) {
            if (confirm(`Are you sure you want to restore from snapshot "${snapshotName}"? This action cannot be undone.`)) {
                executeAction('restoreSnapshot');
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('actionModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Handle Enter key in login forms
        document.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                if (document.getElementById('initialLogin').style.display !== 'none') {
                    initiateLogin();
                } else if (document.getElementById('mfaSetup').style.display !== 'none') {
                    verifyMFA();
                } else if (document.getElementById('mfaVerification').style.display !== 'none') {
                    verifyLoginMFA();
                }
            }
        });

        // Auto-format MFA codes
        document.getElementById('mfaCode').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        document.getElementById('verifyCode').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        function selectVM(id) {
            selectedVMId = id;
            renderVMDetails();
            renderVMList();
            showNotification('Selected VM: ' + vmData.find(vm => vm.id === id).name);
        }
    </script>
</body>

</html>